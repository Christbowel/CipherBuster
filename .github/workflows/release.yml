name: Build & Release CipherBuster

on:
  push:
    branches:
      - main
      - optimization-v2
    tags:
      - 'v*'

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
          sudo apt-get install -y libgmp-dev libmpfr-dev libmpc-dev
          pip install gmpy2
      
      - name: Build Linux binary
        run: |
          pyinstaller \
            --onefile \
            --name "cipherbuster-linux" \
            --add-data "lib:lib" \
            --collect-all gmpy2 \
            --hidden-import "gmpy2" \
            --hidden-import "sympy" \
            --hidden-import "rich" \
            --hidden-import "factordb" \
            --hidden-import "cryptography" \
            --hidden-import "Crypto" \
            cipherbuster.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cipherbuster-linux
          path: dist/cipherbuster-linux

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Build Windows binary
        run: |
          pyinstaller `
            --onefile `
            --name "cipherbuster-windows" `
            --add-data "lib;lib" `
            --hidden-import "sympy" `
            --hidden-import "rich" `
            --hidden-import "factordb" `
            --hidden-import "cryptography" `
            --hidden-import "Crypto" `
            cipherbuster.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cipherbuster-windows
          path: dist/cipherbuster-windows.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          brew install gmp mpfr libmpc
          pip install -r requirements.txt
          pip install pyinstaller gmpy2
      
      - name: Build macOS binary
        run: |
          pyinstaller \
            --onefile \
            --name "cipherbuster-macos" \
            --add-data "lib:lib" \
            --collect-all gmpy2 \
            --hidden-import "gmpy2" \
            --hidden-import "sympy" \
            --hidden-import "rich" \
            --hidden-import "factordb" \
            --hidden-import "cryptography" \
            --hidden-import "Crypto" \
            cipherbuster.py
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cipherbuster-macos
          path: dist/cipherbuster-macos

  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write  
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "CipherBuster ${{ github.ref_name }}"
          body: |
            # üîê CipherBuster ${{ github.ref_name }}
            
            ## ‚ú® Nouveaut√©s
            - 19 attaques RSA (vs 9 en v1)
            - Key Loader universel (PEM, DER, SSH, JWK, XML, PGP...)
            - Auto-detect intelligent
            - Interface Rich professionnelle
            - Architecture modulaire
            
            ## üì¶ Binaires disponibles
            
            | Plateforme | Fichier | Architecture |
            |------------|---------|--------------|
            | üêß Linux | `cipherbuster-linux` | x86_64 |
            | ü™ü Windows | `cipherbuster-windows.exe` | x86_64 |
            | üçé macOS | `cipherbuster-macos` | x86_64/ARM |
            
            ## üöÄ Utilisation rapide
            ```bash
            # Linux/macOS
            chmod +x cipherbuster-linux
            ./cipherbuster-linux
            
            # Windows
            cipherbuster-windows.exe
            ```
            
            - Fermat (optimis√©)
            - Fermat Variants (skip2, mod8, adaptive)
            - Pollard's Rho (Floyd)
            - Pollard's p-1
            - Williams p+1
            - Multi-Prime RSA
            - Wiener's Attack (corrig√©)
            - H√•stad Broadcast
            - Cube Root (e=3)
            - Small e + Padding
            - LSB Oracle
            - Franklin-Reiter (corrig√©)
            - Common Modulus
            - Common Prime Factor
            - Batch GCD
            - Partial Key Exposure
            - Known Plaintext
            - Smooth Number Detection
            - FactorDB Lookup
            
            Outil √©ducatif et de recherche en s√©curit√© uniquement.
          files: |
            cipherbuster-linux/cipherbuster-linux
            cipherbuster-windows/cipherbuster-windows.exe
            cipherbuster-macos/cipherbuster-macos
          token: ${{ secrets.GITHUB_TOKEN }}